# 需求文档

## 简介

本文档定义了基于 microWakeWord 的可定制唤醒词语音唤醒组件（xn_voice_wake）的需求规格。该组件将作为 ESP32-S3 项目的独立模块，遵循现有项目架构风格（如 xn_ota_manger、xn_web_wifi_manger），提供灵活的语音唤醒功能，支持自定义唤醒词。

## 技术方案：microWakeWord

### 方案概述

microWakeWord 是一个开源的唤醒词检测框架，基于 TensorFlow Lite for Microcontrollers，专为 ESP32-S3 等低功耗设备设计。

### 技术特点

| 特性 | 说明 |
|------|------|
| 支持平台 | ESP32-S3（需 PSRAM） |
| 自定义唤醒词 | ✅ 支持，需自行训练模型 |
| 离线运行 | ✅ 完全离线 |
| 功耗 | 低功耗 |
| 授权 | Apache 2.0 完全免费 |
| 模型格式 | TensorFlow Lite (.tflite) |
| 音频格式 | 16kHz 单声道 |

### 工作原理

```
音频输入 (16kHz) → 频谱特征提取 (每10ms) → 神经网络推理 (每30ms) → 概率输出 → 滑动窗口判定
```

1. 音频预处理：将原始音频转换为 40 维频谱特征
2. 流式推理：使用 MixConv 神经网络进行流式推理
3. 滑动窗口：连续多帧高概率则判定为唤醒

### 硬件要求

| 硬件 | 要求 |
|------|------|
| MCU | ESP32-S3（必须，普通 ESP32 不支持） |
| PSRAM | 必须，至少 2MB |
| 麦克风 | I2S 数字麦克风（INMP441、SPH0645 等） |

## 术语表

- **语音唤醒模块**: 负责检测唤醒词并触发回调的核心模块
- **唤醒词**: 用于激活语音助手的特定词语或短语
- **音频处理器**: 负责采集和预处理麦克风音频数据的组件
- **特征提取器**: 将音频转换为频谱特征的组件
- **模型管理器**: 负责加载和管理 TFLite 唤醒词模型的组件
- **检测引擎**: 执行 TFLite 推理的核心组件
- **置信度分数**: 表示检测到唤醒词的可信程度（0.0-1.0）
- **滑动窗口**: 用于平滑检测结果的时间窗口

## 需求列表

### 需求 1：模块初始化

**用户故事：** 作为开发者，我希望能够通过配置初始化语音唤醒模块，以便设置唤醒词检测系统。

#### 验收标准

1. 当模块提供默认配置宏 `VOICE_WAKE_DEFAULT_CONFIG()` 时，语音唤醒模块应当正常工作
2. 当使用有效配置初始化模块时，语音唤醒模块应当返回 ESP_OK
3. 当使用 NULL 配置初始化模块时，语音唤醒模块应当使用默认配置
4. 当模块已经初始化时，语音唤醒模块应当返回 ESP_OK 且不重复初始化
5. 如果因 PSRAM 不足导致初始化失败，则语音唤醒模块应当返回 ESP_ERR_NO_MEM 并记录错误日志
6. 语音唤醒模块应当在初始化时验证 ESP32-S3 芯片类型

### 需求 2：唤醒词模型管理

**用户故事：** 作为开发者，我希望能够加载和管理 TFLite 唤醒词模型，以便在应用中使用自定义唤醒词。

#### 验收标准

1. 模型管理器应当支持从嵌入式二进制（DRAM/PSRAM）加载 TFLite 模型
2. 模型管理器应当支持从 SPIFFS/LittleFS 文件系统加载 TFLite 模型
3. 当加载有效的 TFLite 模型时，模型管理器应当返回 ESP_OK 并分配 TFLite 解释器
4. 当加载无效的模型格式时，模型管理器应当返回 ESP_ERR_INVALID_ARG
5. 模型管理器应当支持卸载模型以释放 PSRAM
6. 模型管理器应当提供 API 查询模型信息（名称、大小、版本）
7. 模型管理器应当支持同时加载多个模型（最多 3 个）

### 需求 3：音频采集与处理

**用户故事：** 作为开发者，我希望模块能够从 I2S 麦克风采集和处理音频，以便从语音输入中检测唤醒词。

#### 验收标准

1. 音频处理器应当支持 I2S 麦克风输入（INMP441、SPH0645、MSM261S4030H0）
2. 音频处理器应当配置 I2S 为 16kHz 采样率、16 位单声道格式
3. 音频处理器应当提供可配置的 I2S 引脚（BCK、WS、DATA）
4. 音频处理器应当使用 DMA 进行高效音频采集
5. 当音频采集开始时，音频处理器应当持续向特征提取器输送数据
6. 音频处理器应当支持暂停和恢复操作，无需重新初始化 I2S
7. 如果 I2S 初始化失败，则音频处理器应当返回 ESP_ERR_NOT_FOUND

### 需求 4：特征提取

**用户故事：** 作为开发者，我希望音频能够被转换为频谱特征，以便神经网络能够处理。

#### 验收标准

1. 特征提取器应当生成 40 维频谱特征
2. 特征提取器应当使用 30ms 窗口和 10ms 步进处理音频
3. 特征提取器应当包含噪声抑制预处理
4. 特征提取器应当包含自动增益控制
5. 特征提取器应当输出与 microWakeWord 模型输入格式兼容的特征

### 需求 5：唤醒词检测

**用户故事：** 作为开发者，我希望能够使用 TFLite 推理实时检测唤醒词，以便应用能够响应语音命令。

#### 验收标准

1. 检测引擎应当每 30ms 执行一次 TFLite 推理
2. 当推理概率超过阈值时，检测引擎应当更新滑动窗口
3. 检测引擎应当提供可配置的概率阈值（默认 0.5）
4. 检测引擎应当提供可配置的滑动窗口大小（默认 5 帧）
5. 当滑动窗口平均值超过阈值时，检测引擎应当触发唤醒词回调
6. 检测引擎应当提供可配置的检测冷却时间（默认 1000ms）
7. 当加载多个模型时，检测引擎应当对所有模型运行推理

### 需求 6：状态管理与回调

**用户故事：** 作为开发者，我希望能够监控模块状态并接收检测事件，以便将唤醒词检测集成到应用流程中。

#### 验收标准

1. 语音唤醒模块应当定义状态：空闲（IDLE）、监听中（LISTENING）、已检测（DETECTED）、错误（ERROR）
2. 语音唤醒模块应当提供状态变化回调机制
3. 当检测到唤醒词时，语音唤醒模块应当调用检测回调并传递模型索引和置信度
4. 语音唤醒模块应当提供 API 查询当前状态
5. 语音唤醒模块应当提供 API 开始监听（`voice_wake_start()`）
6. 语音唤醒模块应当提供 API 停止监听（`voice_wake_stop()`）
7. 当停止监听时，语音唤醒模块应当暂停音频采集但保留模型在内存中

### 需求 7：资源管理

**用户故事：** 作为开发者，我希望模块能够高效管理资源，以便在 ESP32-S3 上与其他组件并行运行。

#### 验收标准

1. 语音唤醒模块应当在 PSRAM 中分配 TFLite 运行区域
2. 语音唤醒模块应当每个模型使用约 100-200KB PSRAM
3. 语音唤醒模块应当提供 API 反初始化并释放所有资源
4. 当反初始化时，语音唤醒模块应当释放 TFLite 解释器、音频缓冲区和 I2S 驱动
5. 语音唤醒模块应当以可配置的优先级运行检测任务（默认：tskIDLE_PRIORITY + 3）
6. 语音唤醒模块应当使用可配置的任务栈大小（默认：4096 字节）

### 需求 8：错误处理

**用户故事：** 作为开发者，我希望模块能够全面处理错误，以便诊断和恢复问题。

#### 验收标准

1. 如果发生音频缓冲区溢出，则语音唤醒模块应当记录警告并继续运行
2. 如果 TFLite 推理失败，则语音唤醒模块应当转换到错误状态并调用回调
3. 如果模型分配失败，则语音唤醒模块应当返回 ESP_ERR_NO_MEM
4. 语音唤醒模块应当提供 API 获取最后的错误码
5. 语音唤醒模块应当支持通过重新初始化进行错误恢复

### 需求 9：配置接口

**用户故事：** 作为开发者，我希望能够通过清晰的 API 配置模块，以便为应用自定义行为。

#### 验收标准

1. 语音唤醒模块应当提供包含所有可调参数的配置结构体
2. 配置应当包含 I2S 引脚配置（bck_pin、ws_pin、data_pin）
3. 配置应当包含检测参数（threshold、window_size、cooldown_ms）
4. 配置应当包含模型路径或嵌入式模型指针
5. 配置应当包含回调函数指针
6. 语音唤醒模块应当在初始化时验证配置
